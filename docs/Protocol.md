This document describes the communication protocol between FPGA and
host capture software.

# Message Protocol

The message protocol is a binary protocol.  All messages to and from
the FPGA have the following format:
`<1-byte msgid><1-byte seq><1-byte len> <n 32-bit data> <2-byte crc><1-byte sync>`

The `msgid` indicates the type of content found in the remainder of
the message.  The `seq` is a sequence number (currently using only the
lower 6 bits).  The `len` field determines the number of 32-bit
entries that will be contained in the following `data` field.  The
`data` field contains data (as determined by the msgid field).  The
`crc` field contains a 16-bit CRC-16-CCITT of the message (covering
msgid to data).  The `sync` field is 0x7e.

The following `msgid` are available:
- REQUEST (0x52): Messages generated from the host capture software
  intended for the FPGA.  There is always exactly one 32-bit data item
  in these messages.  That data item has the following format:
  `<1 byte write_flag><2-byte address><1-byte write_data>`

  The `write_flag` is either 0x80 to indicate a write to the given
  address or 0x00 to indicate a read of the given address.  The
  `address` field is the register address to read or write (encoded in
  little-endian).  The `write_data` is the data to write for write
  requests (the field must be present for read requests, but is
  otherwise ignored).

- RESPONSE (0x60): Messages generated from the FPGA in response to a
  valid REQUEST message.  The FPGA generates this message for valid
  read and valid write request messages.  There is always exactly one
  32-bit data item in these messages.  That data item has the
  following format:
  `<1 byte read_data><1-byte req_seq><1-byte seq_err><1-byte zero>`

  The `read_data` contains the associated data from a valid read
  request (the field is present in response to write requests, but
  only contains valid data on read requests).  The `req_seq` reports
  the next expected sequence number of a REQUEST message.  (For valid
  requests, this number is always one greater than the message that
  generated the message.)  The `seq_err` field is 0x00 for normal
  responses and is 0x01 if the FPGA received a valid request with an
  incorrect sequence number.  The `zero` field is always 0x00.

  If `seq_err` is set then the requested message was not processed by
  the FPGA.  In this case the `read_data` field should be ignored.
  The host should resend the request using the sequence number found
  in the `req_seq` field.

- SAMPLE (0x61): Messages generated by the FPGA containing data from
  its internal "samples queue".  There may be between 1 and 255 32-bit
  samples provided in each message.  The contents of each sample entry
  are dependent on the configuration of the FPGA "samples queue".

# Register Addresses

Each REQUEST message sent to the FPGA generates an internal
transaction on the FPGA's wishbone bus.  The transaction can either be
a read transaction (read data from a register at an address) or a
write transaction (write data to a register at an address).  The FPGA
then responds with a RESPONSE message.  For read requests, the
RESPONSE message will contain the data read from the requested
address.

The registers at each address can be found in the
[fpgaregs.py](../src/fpgaregs.py) module.  The fields within those
registers are not currently documented.
